pipeline {
    agent none

    environment {
        DOCKER_REGISTRY = 'jubelshaji'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout Source') {
            agent {
                kubernetes {
                    yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  containers:
    - name: git
      image: alpine/git:latest
      command:
        - cat
      tty: true
      volumeMounts:
        - name: jenkins-workspace
          mountPath: /workspace
  volumes:
    - name: jenkins-workspace
      persistentVolumeClaim:
        claimName: shared-workspace
'''
                }
            }
            steps {
                container('git') {
                    git branch: 'main',
                    url: 'https://github.com/JubelShaji/CI-CD-Voting-App.git'
                }
            }
        }

        stage('Build & Push Docker Images with Kaniko') {
            parallel {
                stage('Build Vote Image') {
                    agent {
                        kubernetes {
                            yaml '''
apiVersion: v1
kind: Pod
metadata:
  name: kaniko-vote-\${BUILD_NUMBER}
spec:
  serviceAccountName: jenkins
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      command:
        - /kaniko/executor
      args:
        - '--context=dir://$(pwd)/vote'
        - '--dockerfile=Dockerfile'
        - '--destination=jubelshaji/simple_vote_app:vote-\${BUILD_NUMBER}'
        - '--destination=jubelshaji/simple_vote_app:vote-latest'
        - '--verbosity=info'
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: jenkins-workspace
          mountPath: /workspace
  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
    - name: jenkins-workspace
      persistentVolumeClaim:
        claimName: shared-workspace
'''
                        }
                    }
                    steps {
                        echo "üöÄ Building Vote image with Kaniko pod"
                        container('kaniko') {
                            echo "Vote image build completed."
                        }
                    }
                }

                stage('Build Seed Image') {
                    agent {
                        kubernetes {
                            yaml '''
apiVersion: v1
kind: Pod
metadata:
  name: kaniko-seed-\${BUILD_NUMBER}
spec:
  serviceAccountName: jenkins
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      command:
        - /kaniko/executor
      args:
        - '--context=dir://$(pwd)/seed-data'
        - '--dockerfile=Dockerfile'
        - '--destination=jubelshaji/simple_vote_app:seed-\${BUILD_NUMBER}'
        - '--destination=jubelshaji/simple_vote_app:seed-latest'
        - '--verbosity=info'
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: jenkins-workspace
          mountPath: /workspace
  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
    - name: jenkins-workspace
      persistentVolumeClaim:
        claimName: shared-workspace
'''
                        }
                    }
                    steps {
                        echo "üöÄ Building Seed image with Kaniko pod"
                        container('kaniko') {
                            echo "Seed image build completed."
                        }
                    }
                }

                stage('Build Worker Image') {
                    agent {
                        kubernetes {
                            yaml '''
apiVersion: v1
kind: Pod
metadata:
  name: kaniko-worker-\${BUILD_NUMBER}
spec:
  serviceAccountName: jenkins
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      command:
        - /kaniko/executor
      args:
        - '--context=dir://$(pwd)/worker'
        - '--dockerfile=Dockerfile'
        - '--destination=jubelshaji/simple_vote_app:worker-\${BUILD_NUMBER}'
        - '--destination=jubelshaji/simple_vote_app:worker-latest'
        - '--verbosity=info'
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: jenkins-workspace
          mountPath: /workspace
  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
    - name: jenkins-workspace
      persistentVolumeClaim:
        claimName: shared-workspace
'''
                        }
                    }
                    steps {
                        echo "üöÄ Building Worker image with Kaniko pod"
                        container('kaniko') {
                            echo "Worker image build completed."
                        }
                    }
                }

                stage('Build Result Image') {
                    agent {
                        kubernetes {
                            yaml '''
apiVersion: v1
kind: Pod
metadata:
  name: kaniko-result-\${BUILD_NUMBER}
spec:
  serviceAccountName: jenkins
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      command:
        - /kaniko/executor
      args:
        - '--context=dir://$(pwd)/result'
        - '--dockerfile=Dockerfile'
        - '--destination=jubelshaji/simple_vote_app:result-\${BUILD_NUMBER}'
        - '--destination=jubelshaji/simple_vote_app:result-latest'
        - '--verbosity=info'
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: jenkins-workspace
          mountPath: /workspace
  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
    - name: jenkins-workspace
      persistentVolumeClaim:
        claimName: shared-workspace
'''
                        }
                    }
                    steps {
                        echo "üöÄ Building Result image with Kaniko pod"
                        container('kaniko') {
                            echo "Result image build completed."
                        }
                    }
                }
            }
        }

        stage('Update Kubernetes Manifests') {
            agent any
            steps {
                sh """
                    sed -i 's|jubelshaji/simple_vote_app:vote-latest|jubelshaji/simple_vote_app:vote-${BUILD_NUMBER}|g' k8s-specifications/vote-deployment.yaml
                    sed -i 's|jubelshaji/simple_vote_app:worker-latest|jubelshaji/simple_vote_app:worker-${BUILD_NUMBER}|g' k8s-specifications/worker-deployment.yaml
                    sed -i 's|jubelshaji/simple_vote_app:result-latest|jubelshaji/simple_vote_app:result-${BUILD_NUMBER}|g' k8s-specifications/result-deployment.yaml
                """
            }
        }

        stage('Deploy to Kubernetes') {
            agent any
            steps {
                sh "kubectl apply -f k8s-specifications/"
            }
        }
    }

    post {
        success {
            echo 'üéâ Pipeline completed successfully! Images built, pushed & deployed.'
        }
        failure {
            echo '‚ùå Pipeline failed. Check logs for details.'
        }
    }
}
