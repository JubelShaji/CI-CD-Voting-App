pipeline {
    agent none

    environment {
        DOCKER_REGISTRY = 'jubelshaji'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }

    stages {
        stage('Building Containers') {
            agent {
                kubernetes {
                    yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  containers:
    - name: git
      image: alpine/git:latest
      command: ['cat']
      tty: true
      securityContext:
        runAsUser: 0
      volumeMounts:
        - name: shared-workspace
          mountPath: /workspace

    - name: kaniko-vote
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: shared-workspace
          mountPath: /workspace

    - name: kaniko-seed
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: shared-workspace
          mountPath: /workspace

    - name: kaniko-worker
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: shared-workspace
          mountPath: /workspace

    - name: kaniko-result
      image: gcr.io/kaniko-project/executor:debug
      command: ['sleep', 'infinity']
      tty: true
      volumeMounts:
        - name: kaniko-secret
          mountPath: /kaniko/.docker
          readOnly: true
        - name: shared-workspace
          mountPath: /workspace

  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
    - name: shared-workspace
      emptyDir: {}
"""
                }
            }

            stages {
                stage('Checkout Source') {
                    steps {
                        container('git') {
                            echo "üì¶ Checking out source code..."
                            dir('/workspace') {
                                git branch: 'main', url: 'https://github.com/JubelShaji/CI-CD-Voting-App.git'
                            }
                        }
                    }
                }

                stage('Build Images in Parallel') {
                    parallel {
                        stage('Build Vote Image') {
                            steps {
                                container('kaniko-vote') {
                                    echo "üöÄ Building Vote image..."
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///workspace/vote \
                                        --dockerfile=/workspace/vote/Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:vote-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:vote-latest \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }

                        stage('Build Seed Image') {
                            steps {
                                container('kaniko-seed') {
                                    echo "üöÄ Building Seed image..."
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///workspace/seed-data \
                                        --dockerfile=/workspace/seed-data/Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:seed-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:seed-latest \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }

                        stage('Build Worker Image') {
                            steps {
                                container('kaniko-worker') {
                                    echo "üöÄ Building Worker image..."
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///workspace/worker \
                                        --dockerfile=/workspace/worker/Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:worker-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:worker-latest \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }

                        stage('Build Result Image') {
                            steps {
                                container('kaniko-result') {
                                    echo "üöÄ Building Result image..."
                                    sh '''
                                    /kaniko/executor \
                                        --context=dir:///workspace/result \
                                        --dockerfile=/workspace/result/Dockerfile \
                                        --destination=jubelshaji/simple_vote_app:result-${BUILD_NUMBER} \
                                        --destination=jubelshaji/simple_vote_app:result-latest \
                                        --verbosity=info
                                    '''
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Update Kubernetes Manifests') {
            agent any
            steps {
                sh """
                sed -i 's|jubelshaji/simple_vote_app:vote-latest|jubelshaji/simple_vote_app:vote-${BUILD_NUMBER}|g' k8s-specifications/vote-deployment.yaml
                sed -i 's|jubelshaji/simple_vote_app:worker-latest|jubelshaji/simple_vote_app:worker-${BUILD_NUMBER}|g' k8s-specifications/worker-deployment.yaml
                sed -i 's|jubelshaji/simple_vote_app:result-latest|jubelshaji/simple_vote_app:result-${BUILD_NUMBER}|g' k8s-specifications/result-deployment.yaml
                """
            }
        }

        stage('Deploy to Kubernetes') {
            agent any
            steps {
                sh 'kubectl apply -f k8s-specifications/'
            }
        }
    }

    post {
        success {
            echo 'üéâ All Docker images built, pushed & deployed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed. Check logs for errors.'
        }
    }
}
